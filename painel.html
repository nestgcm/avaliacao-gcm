<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Acompanhamento - GCM Salvador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8;
            --bg-main: #f0f9ff; --bg-card: #ffffff;
            --text-title: #1e293b; --text-body: #475569;
            --success: #10b981; --danger: #f59e0b;
            --border-color: #e2e8f0; --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --primary: #38bdf8; --primary-dark: #0ea5e9;
            --bg-main: #0b1120; --bg-card: #1e293b;
            --text-title: #f1f5f9; --text-body: #94a3b8;
            --success: #2dd4bf; --danger: #fb923c;
            --border-color: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-body);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
        }

        .hidden { display: none !important; }

        /* --- TELA DE LOGIN ATUALIZADA E PADRONIZADA --- */
        #login-screen-wrapper { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; padding: 2rem 1rem; }
        .login-container { 
            width: 100%; 
            max-width: 480px; /* Largura ajustada para um formulário vertical */
            min-height: auto; 
            display: flex; 
            flex-direction: column; /* *** ALTERAÇÃO PRINCIPAL: Garante o layout vertical sempre *** */
            background-color: var(--bg-card); 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-lg); 
            overflow: hidden; 
            animation: fadeIn 0.5s ease-in-out; 
        }
        .login-art { 
            width: 100%; /* Ocupa toda a largura do container */
            background: linear-gradient(160deg, #1e3a8a, #2563eb);
            padding: 2.5rem; 
            display: flex; flex-direction: column; 
            justify-content: center; text-align: center; 
            color: #ffffff;
        }
        .login-art h1 { font-size: 1.5rem; line-height: 1.3; font-weight: 600; }
        .login-art p { font-size: 1rem; opacity: 0.8; margin-top: 0.5rem; }
        .login-art .illustration { width: 100px; margin: 0 auto 1.5rem auto; } /* Ilustração um pouco menor */
        
        .login-form { 
            width: 100%; /* Ocupa toda a largura do container */
            padding: 2rem 2.5rem 3rem 2.5rem; /* Ajuste no padding */
            display: flex; flex-direction: column; 
            justify-content: center; 
        }
        .login-form h2 { font-size: 1.8rem; color: var(--text-title); margin-bottom: 0.5rem;}
        .login-form p { margin-bottom: 2.5rem; }
        .input-group { margin-bottom: 1.5rem; position: relative; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-title); }
        .input-group input { width: 100%; padding: 0.9rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-main); color: var(--text-title); transition: all var(--transition-speed); }
        .input-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
        #toggle-senha { position: absolute; right: 1rem; top: 50%; transform: translateY(50%); background: none; border: none; cursor: pointer; color: var(--text-body); font-size: 1rem; }
        
        #login-button { width: 100%; padding: 1rem; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        #login-button:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow); }
        #login-button:disabled { opacity: 0.7; cursor: wait; }
        #login-button .spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        #login-button.loading .button-text { display: none; }
        #login-button.loading .spinner { display: block; }
        #login-alert { background-color: color-mix(in srgb, var(--danger) 15%, transparent); color: var(--danger); border: 1px solid var(--danger); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; text-align: center; }

        /* --- ADMIN SCREEN --- */
        #admin-screen { width: 100%; max-width: 1600px; margin: 0 auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; min-height: 100vh; }
        header { background-color: var(--bg-card); color: var(--text-title); border: 1px solid var(--border-color); padding: 1.5rem 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;}
        .header-title { font-size: 1.8rem; font-weight: 600; color: var(--text-title); }
        .header-title .user-name { color: var(--primary); }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .header-controls .control-btn { background-color: transparent; border: none; color: var(--text-body); font-size: 1.5rem; cursor: pointer; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: color var(--transition-speed), background-color var(--transition-speed), transform var(--transition-speed); }
        .header-controls .control-btn:hover { color: var(--primary); background-color: var(--bg-main); transform: scale(1.1); }
        .data-controls { display: flex; align-items: center; gap: 0.75rem; }
        .data-status { font-size: 0.8rem; color: var(--text-body); display: flex; align-items: center; gap: 0.5rem; }
        .data-status .live-indicator { width: 8px; height: 8px; background-color: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        #refresh-button { font-size: 1.2rem; }
        #refresh-button:hover { background-color: transparent; transform: rotate(180deg); }
        #refresh-select { font-family: 'Inter', sans-serif; font-size: 0.8rem; background-color: var(--bg-main); color: var(--text-body); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.25rem 0.5rem; }
        #dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: var(--bg-card); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; overflow: hidden; animation: fadeInUp 0.5s ease-in-out forwards; opacity: 0; }
        .stat-card::after { font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; right: 1.5rem; bottom: 1rem; font-size: 4rem; color: var(--primary); opacity: 0.08; transform: rotate(-15deg); transition: opacity var(--transition-speed); z-index: 0; }
        .stat-card.autoavaliação::after { content: '\f4fe'; }
        .stat-card.chefia::after { content: '\f505'; }
        .stat-card-header, .stat-details, .progress-container { position: relative; z-index: 1; }
        .stat-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
        .stat-card-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--text-body); }
        .stat-details { width: 100%; }
        .detail-line { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; margin-bottom: 0.5rem; }
        .detail-line span { color: var(--text-body); }
        .detail-line strong { font-weight: 600; color: var(--text-title); }
        .detail-line.concluded strong { color: var(--success); }
        .detail-line.pending strong { color: var(--danger); }
        .progress-container { display: flex; width: 100%; height: 10px; border-radius: 5px; overflow: hidden; background-color: color-mix(in srgb, var(--danger) 20%, transparent); margin-top: 1rem; }
        .progress-bar { height: 100%; transition: width 0.8s ease-in-out; }
        .progress-bar-concluido { background-color: var(--success); }
        .progress-bar-pendente { background-color: var(--danger); }
        
        /* --- ESTILOS DA TABELA E FILTROS --- */
        #table-container { background-color: var(--bg-card); border: 1px solid var(--border-color); flex-grow: 1; display: flex; flex-direction: column; padding: 2rem 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        #table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1.5rem; }
        .search-wrapper { position: relative; }
        #search-input { width: 100%; max-width: 350px; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-title); border-radius: 20px; }
        .search-wrapper .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-body); }
        
        #filter-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #filter-controls button { padding: 0.6rem 1.2rem; border: 1px solid var(--border-color); background-color: var(--bg-card); color: var(--text-body); cursor: pointer; border-radius: 20px; transition: all var(--transition-speed); font-weight: 500; }
        #filter-controls button.active { background-color: var(--primary); color: #fff; border-color: var(--primary); box-shadow: var(--shadow); }
        #filter-controls button .count { font-size: 0.8em; margin-left: 0.5rem; background-color: var(--border-color); color: var(--text-body); padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        #filter-controls button.active .count { background-color: #fff; color: var(--primary); }

        .table-wrapper { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        thead { position: sticky; top: 0; background-color: var(--bg-card); z-index: 10; }
        th { font-weight: 600; color: var(--text-body); text-transform: uppercase; font-size: 0.75rem; padding: 1rem 1.2rem; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: var(--bg-main); }
        th .sort-icon { margin-left: 0.5rem; opacity: 0.6; width: 1em; display: inline-block; text-align: center; }

        tbody tr { background-color: var(--bg-card); border-radius: var(--border-radius); box-shadow: var(--shadow); transition: all var(--transition-speed); border-left: 5px solid; animation: fadeInUp 0.5s ease-in-out forwards; opacity: 0;}
        tbody tr.status-auto-concluida { border-left-color: var(--success); }
        tbody tr.status-auto-pendente { border-left-color: var(--danger); }
        tbody tr:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        td { padding: 1rem 1.2rem; border: none; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .user-cell { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; flex-shrink: 0; }
        .user-name { font-weight: 600; color: var(--text-title); }
        .status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .status-concluida { background-color: color-mix(in srgb, var(--success) 15%, transparent); color: var(--success); }
        .status-pendente { background-color: color-mix(in srgb, var(--danger) 15%, transparent); color: var(--danger); }
        #loader { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--primary); }
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-state i { font-size: 3rem; color: var(--border-color); }
        .empty-state h3 { color: var(--text-title); margin-top: 1.5rem; }
        .empty-state p { margin-top: 0.5rem; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--success) 50%, transparent); } 100% { box-shadow: 0 0 0 10px transparent; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- RESPONSIVIDADE DA TABELA --- */
        @media (max-width: 820px) {
            thead { display: none; }
            tbody tr { display: block; width: 100%; margin-bottom: 1rem; }
            td { display: block; width: 100%; border-bottom: 1px solid var(--border-color); text-align: right !important; padding-left: 50%; position: relative; }
            td:before { content: attr(data-label); position: absolute; left: 1.2rem; width: 45%; text-align: left; font-weight: 600; color: var(--text-title); text-transform: uppercase; font-size: 0.75rem; }
            td.user-cell { text-align: left !important; padding-left: 1.2rem; border-bottom: 2px solid var(--border-color); }
            td.user-cell:before { content: none; }
            td:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>
    <div id="login-screen-wrapper" role="main">
        <div class="login-container">
            <div class="login-art">
                <svg class="illustration" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.09961C12.5523 2.09961 13 2.54734 13 3.09961V5.09961C13 5.65188 12.5523 6.09961 12 6.09961C11.4477 6.09961 11 5.65188 11 5.09961V3.09961C11 2.54734 11.4477 2.09961 12 2.09961Z" opacity="0.4"></path><path d="M12 18.0996C12.5523 18.0996 13 18.5473 13 19.0996V21.0996C13 21.6519 12.5523 22.0996 12 22.0996C11.4477 22.0996 11 21.6519 11 21.0996V19.0996C11 18.5473 11.4477 18.0996 12 18.0996Z" opacity="0.4"></path><path d="M5.90909 5.90909C6.35682 5.46136 7.00039 5.46136 7.44812 5.90909L8.86234 7.3233C9.30993 7.7709 9.30993 8.41434 8.86234 8.86193C8.41474 9.30953 7.7713 9.30953 7.3237 8.86193L5.90948 7.44772C5.46189 7.00012 5.46189 6.35668 5.90948 5.90909H5.90909Z" opacity="0.4"></path><path d="M15.1361 15.1361C15.5838 14.6884 16.2274 14.6884 16.6751 15.1361L18.0893 16.5503C18.5369 16.9979 18.5369 17.6413 18.0893 18.0889C17.6417 18.5365 16.9983 18.5365 16.5507 18.0889L15.1365 16.6747C14.6889 16.2271 14.6889 15.5837 15.1365 15.1361H15.1361Z" opacity="0.4"></path><path d="M21.0996 11H19.0996C18.5473 11 18.0996 11.4477 18.0996 12C18.0996 12.5523 18.5473 13 19.0996 13H21.0996C21.6519 13 22.0996 12.5523 22.0996 12C22.0996 11.4477 21.6519 11 21.0996 11Z" opacity="0.4"></path><path d="M6.09961 11H4.09961C3.54734 11 3.09961 11.4477 3.09961 12C3.09961 12.5523 3.54734 13 4.09961 13H6.09961C6.65188 13 7.09961 12.5523 7.09961 12C7.09961 11.4477 6.65188 11 6.09961 11Z" opacity="0.4"></path><path d="M8.86234 15.1361C8.41474 14.6884 7.7713 14.6884 7.3237 15.1361L5.90948 16.5503C5.46189 16.9979 5.46189 17.6413 5.90948 18.0889C6.35708 18.5365 7.00052 18.5365 7.44812 18.0889L8.86234 16.6747C9.31007 16.227 9.31007 15.5835 8.86234 15.1361Z" opacity="0.4"></path><path d="M16.6751 5.90909C16.2274 5.46136 15.5838 5.46136 15.1361 5.90909L13.7219 7.3233C13.2743 7.7709 13.2743 8.41434 13.7219 8.86193C14.1695 9.30953 14.8129 9.30953 15.2605 8.86193L16.6747 7.44772C17.1223 7.00012 17.1223 6.35668 16.6747 5.90909H16.6751Z" opacity="0.4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.59961C8.46396 6.59961 5.59961 9.46396 5.59961 13C5.59961 16.536 8.46396 19.4004 12 19.4004C15.536 19.4004 18.4004 16.536 18.4004 13C18.4004 9.46396 15.536 6.59961 12 6.59961ZM7.09961 13C7.09961 10.2386 9.33817 8.09961 12 8.09961C14.6618 8.09961 16.9004 10.2386 16.9004 13C16.9004 15.7614 14.6618 17.9004 12 17.9004C9.33817 17.9004 7.09961 15.7614 7.09961 13Z"></path></svg>
                <h1>Painel de Acompanhamento<br>das Avaliações de Desempenho</h1>
                <p>Guarda Civil Municipal de Salvador</p>
            </div>
            <div class="login-form">
                <h2>Bem-vindo(a)</h2>
                <p>Faça login para continuar.</p>
                <div class="input-group"><label for="matricula">Matrícula</label><input type="text" id="matricula" placeholder="Digite sua matrícula" aria-required="true"></div>
                <div class="input-group">
                    <label for="senha">Senha</label>
                    <input type="password" id="senha" placeholder="Digite sua senha" aria-required="true">
                    <button id="toggle-senha" type="button" aria-label="Mostrar senha"><i class="fas fa-eye"></i></button>
                </div>
                <button id="login-button" type="button"><span class="button-text">Entrar</span><div class="spinner"></div></button>
                <div id="login-alert" class="hidden" role="alert" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <div id="admin-screen" class="hidden">
        <header>
            <div class="header-title"><i class="fas fa-chart-pie" style="color: var(--primary)"></i> <span id="dashboard-title"></span></div>
            <div class="header-controls">
                <div class="data-controls">
                    <div id="data-status" class="data-status"></div>
                    <button id="refresh-button" class="control-btn" title="Atualizar Agora" aria-label="Atualizar dados agora"><i class="fas fa-sync"></i></button>
                    <select id="refresh-select" title="Atualização Automática" aria-label="Intervalo de atualização automática"><option value="0">Manual</option><option value="60000">1 min</option><option value="300000">5 min</option></select>
                </div>
                <button id="theme-toggle" class="control-btn" title="Alterar Tema" aria-label="Alterar tema visual"><i class="fas fa-sun"></i></button>
                <button id="logout-button" class="control-btn" title="Sair" aria-label="Sair do sistema"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>
        <div id="dashboard-stats"></div>
        <div id="table-container">
             <div id="table-controls">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="search" id="search-input" placeholder="Buscar por nome ou matrícula..." aria-controls="servidores-tbody">
                </div>
                <div id="filter-controls" role="group" aria-label="Filtrar por status"></div>
            </div>
            <div id="loader"><i class="fas fa-spinner fa-spin"></i> Carregando dados...</div>
            <div class="table-wrapper">
                <table class="hidden">
                    <thead>
                        <tr>
                            <th scope="col" id="th-nome" class="sortable" aria-sort="none">Servidor<span class="sort-icon"></span></th>
                            <th scope="col" id="th-matricula" class="sortable" aria-sort="none">Matrícula<span class="sort-icon"></span></th>
                            <th scope="col" id="th-lotacao" class="sortable" aria-sort="none">Lotação<span class="sort-icon"></span></th>
                            <th scope="col" style="text-align:center;">Autoavaliação</th>
                            <th scope="col" style="text-align:center;">Avaliação Chefia</th>
                        </tr>
                    </thead>
                    <tbody id="servidores-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1PSNWaC0X12aFgafJNDWkgyh5PD1Vg-LitYUzrLWY3HgJ40qKLt6rEJ9OMDkVWii5/exec';
            const dom = {
                loginWrapper: document.getElementById('login-screen-wrapper'), adminScreen: document.getElementById('admin-screen'),
                loginButton: document.getElementById('login-button'), logoutButton: document.getElementById('logout-button'),
                matriculaInput: document.getElementById('matricula'), senhaInput: document.getElementById('senha'), 
                loginAlert: document.getElementById('login-alert'), loader: document.getElementById('loader'), 
                table: document.querySelector('#table-container table'), tableHead: document.querySelector('#table-container table thead'),
                servidoresTbody: document.getElementById('servidores-tbody'), searchInput: document.getElementById('search-input'),
                statsContainer: document.getElementById('dashboard-stats'), filterControls: document.getElementById('filter-controls'),
                themeToggle: document.getElementById('theme-toggle'), dashboardTitle: document.getElementById('dashboard-title'),
                refreshButton: document.getElementById('refresh-button'), refreshSelect: document.getElementById('refresh-select'),
                dataStatus: document.getElementById('data-status'),
                toggleSenha: document.getElementById('toggle-senha'),
            };

            let allServidores = [], currentFilter = 'all', refreshInterval = null;
            let sortConfig = { key: 'nome', direction: 'ascending' }; 

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme);
                dom.themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            };

            const getInitials = (name) => {
                const n = (name || '').split(' ');
                return n.length > 1 ? `${n[0][0]}${n[n.length-1][0]}`.toUpperCase() : (name || '').substring(0,2).toUpperCase();
            };
            const avatarColors=["#ef4444","#f97316","#eab308","#84cc16","#22c55e","#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e"];
            const getColorForName = (name) => { let h=0; for(let i=0;i<(name||'').length;i++)h=(name||'').charCodeAt(i)+((h<<5)-h); return avatarColors[Math.abs(h)%avatarColors.length]; };
            
            async function callApi(action, payload = {}) { try { const r=await fetch(WEB_APP_URL,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action,...payload})}); if(!r.ok) throw new Error(`Erro: ${r.statusText}`); return await r.json(); } catch(e){ console.error('API Error:',e); throw e; } }
            
            async function handleLogin() {
                if(!dom.matriculaInput.value||!dom.senhaInput.value) return showAlert('Preencha matrícula e senha.');
                dom.loginButton.classList.add('loading'); dom.loginButton.disabled = true;
                dom.loginAlert.classList.add('hidden');
                try{ 
                    const r = await callApi('loginAdmin',{matricula:dom.matriculaInput.value,senha:dom.senhaInput.value});
                    if(r.success){
                        dom.dashboardTitle.innerHTML = `<span class="user-name">Bem-vindo, ${r.user.nome.split(' ')[0]}!</span>`;
                        dom.loginWrapper.classList.add('hidden'); 
                        dom.adminScreen.classList.remove('hidden');
                        loadDashboardData();
                    } else { showAlert(r.error || 'Credenciais inválidas.'); }
                } catch(e){ showAlert('Erro de comunicação. Verifique sua conexão.'); } finally { resetLoginButton(); }
            }

            async function loadDashboardData(isRefresh = false) {
                if (!isRefresh) { dom.loader.classList.remove('hidden'); dom.table.classList.add('hidden'); }
                else { dom.refreshButton.querySelector('i').classList.add('fa-spin'); }
                try { 
                    const r=await callApi('getDashboardData'); 
                    if (r.success){ 
                        allServidores = r.servidores || []; 
                        if (!isRefresh){ dom.table.classList.remove('hidden'); } 
                        render(); 
                        setupAutoRefresh();
                    } else { if (!isRefresh) dom.loader.innerHTML=`<i class="fas fa-exclamation-triangle"></i> Erro: ${r.error}`; } 
                } catch(e){ if (!isRefresh) dom.loader.innerHTML=`<i class="fas fa-exclamation-triangle"></i> Falha de comunicação.`; } 
                finally { 
                    if (!isRefresh) dom.loader.classList.add('hidden');
                    else { dom.refreshButton.querySelector('i').classList.remove('fa-spin'); }
                    updateDataStatus();
                }
            }

            const render = () => {
                const processedData = getProcessedData();
                renderFilterCounts(allServidores);
                renderStats(); // Usa allServidores para stats globais
                renderTable(processedData); // Usa dados processados para a tabela
            };

            function getProcessedData() {
                let data = [...allServidores];
                
                // 1. FILTRO PRIMEIRO
                const search = (dom.searchInput.value || '').toLowerCase();
                data = data.filter(s => {
                    const searchMatch = ((s.nome || '').toLowerCase().includes(search) || (s.matricula || '').includes(search));
                    if (!searchMatch) return false;

                    switch (currentFilter) {
                        case 'all': return true;
                        case 'auto-pendente': return s.autoav === 'Pendente';
                        case 'chefia-pendente': return s.chefia === 'Pendente';
                        case 'ambas-pendente': return s.autoav === 'Pendente' && s.chefia === 'Pendente';
                        default: return true;
                    }
                });

                // 2. ORDENAÇÃO DEPOIS
                data.sort((a, b) => {
                    const valA = a[sortConfig.key] || '';
                    const valB = b[sortConfig.key] || '';
                    if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                    return 0;
                });

                return data;
            }

            function renderFilterCounts(data) {
                const allCount = data.length;
                const autoPendenteCount = data.filter(s => s.autoav === 'Pendente').length;
                const chefiaPendenteCount = data.filter(s => s.chefia === 'Pendente').length;
                const ambasPendenteCount = data.filter(s => s.autoav === 'Pendente' && s.chefia === 'Pendente').length;

                dom.filterControls.innerHTML = `
                    <button data-filter="all" class="${currentFilter === 'all' ? 'active' : ''}" aria-pressed="${currentFilter === 'all'}">Todos<span class="count">${allCount}</span></button>
                    <button data-filter="auto-pendente" class="${currentFilter === 'auto-pendente' ? 'active' : ''}" aria-pressed="${currentFilter === 'auto-pendente'}">Auto Pendente<span class="count">${autoPendenteCount}</span></button>
                    <button data-filter="chefia-pendente" class="${currentFilter === 'chefia-pendente' ? 'active' : ''}" aria-pressed="${currentFilter === 'chefia-pendente'}">Chefia Pendente<span class="count">${chefiaPendenteCount}</span></button>
                    <button data-filter="ambas-pendente" class="${currentFilter === 'ambas-pendente' ? 'active' : ''}" aria-pressed="${currentFilter === 'ambas-pendente'}">Ambas Pendentes<span class="count">${ambasPendenteCount}</span></button>
                `;
            }

            function renderStats() {
                const total=allServidores.length;
                const autoC=allServidores.filter(s=>s.autoav==='Concluída').length;
                const chefiaC=allServidores.filter(s=>s.chefia==='Concluída').length;
                
                const createStatCard = (title, icon, cssClass, total, concluidas) => {
                    const pendentes = total - concluidas;
                    const pConcluidas = total > 0 ? (concluidas / total * 100) : 0;
                    const pPendentes = total > 0 ? (pendentes / total * 100) : 0;

                    return `
                    <div class="stat-card ${cssClass}">
                        <div class="stat-card-header">
                            <h3><i class="fas ${icon}" style="color:var(--primary);margin-right:0.5rem;"></i>${title}</h3>
                        </div>
                        <div class="stat-details">
                            <div class="detail-line concluded">
                                <span>Concluído</span>
                                <strong>${concluidas} (${pConcluidas.toFixed(1)}%)</strong>
                            </div>
                            <div class="detail-line pending">
                                <span>Pendente</span>
                                <strong>${pendentes} (${pPendentes.toFixed(1)}%)</strong>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar progress-bar-concluido" style="width:${pConcluidas}%" title="Concluídas: ${pConcluidas.toFixed(1)}%"></div>
                            <div class="progress-bar progress-bar-pendente" style="width:${pPendentes}%" title="Pendentes: ${pPendentes.toFixed(1)}%"></div>
                        </div>
                    </div>`;
                };
                dom.statsContainer.innerHTML = createStatCard('Autoavaliação','fa-user-check', 'autoavaliação', total,autoC) + createStatCard('Avaliação da Chefia','fa-user-shield', 'chefia', total,chefiaC);
            }

            function renderTable(filteredData) {
                if(filteredData.length===0){
                    dom.servidoresTbody.innerHTML=`<tr><td colspan="5"><div class="empty-state"><i class="fas fa-search"></i><h3>Nenhum servidor encontrado</h3><p>Tente ajustar sua busca ou filtro.</p></div></td></tr>`;
                    return;
                }
                dom.servidoresTbody.innerHTML = filteredData.map(s=>{
                    const autoClass=s.autoav==='Concluída'?'status-concluida':'status-pendente', chefiaClass=s.chefia==='Concluída'?'status-concluida':'status-pendente', rowClass=s.autoav==='Concluída'?'status-auto-concluida':'status-auto-pendente';
                    return `<tr class="${rowClass}">
                                <td class="user-cell" data-label="Servidor"><div class="user-cell"><div class="user-avatar" style="background-color:${getColorForName(s.nome)}">${getInitials(s.nome)}</div><span class="user-name">${s.nome}</span></div></td>
                                <td data-label="Matrícula">${s.matricula}</td>
                                <td data-label="Lotação">${s.lotacao}</td>
                                <td data-label="Autoavaliação" style="text-align:center;"><span class="status ${autoClass}">${s.autoav}</span></td>
                                <td data-label="Aval. Chefia" style="text-align:center;"><span class="status ${chefiaClass}">${s.chefia}</span></td>
                            </tr>`;
                }).join('');
            }

            function handleSort(e) {
                const th = e.target.closest('th.sortable');
                if (!th) return;

                const key = th.id.replace('th-', '');
                const direction = sortConfig.key === key && sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                sortConfig = { key, direction };
                
                dom.tableHead.querySelectorAll('th.sortable').forEach(header => {
                    header.setAttribute('aria-sort', 'none');
                    header.querySelector('.sort-icon').innerHTML = '';
                });
                
                th.setAttribute('aria-sort', direction);
                th.querySelector('.sort-icon').innerHTML = direction === 'ascending' ? '<i class="fas fa-arrow-down"></i>' : '<i class="fas fa-arrow-up"></i>';
                
                render();
            }
            
            const updateDataStatus = () => {
                const interval = parseInt(dom.refreshSelect.value);
                if (interval > 0) dom.dataStatus.innerHTML = `<span class="live-indicator"></span> LIVE`;
                else dom.dataStatus.innerHTML = `Atualizado às ${new Date().toLocaleTimeString('pt-BR')}`;
            };
            const setupAutoRefresh = () => {
                if (refreshInterval) clearInterval(refreshInterval);
                const interval = parseInt(dom.refreshSelect.value);
                if (interval > 0) refreshInterval = setInterval(() => loadDashboardData(true), interval);
                updateDataStatus();
            };
            
            const resetLoginButton=()=>{ dom.loginButton.classList.remove('loading'); dom.loginButton.disabled = false; };
            const showAlert=(msg)=>{dom.loginAlert.textContent=msg;dom.loginAlert.classList.remove('hidden');};
            function handleLogout(){allServidores=[];dom.adminScreen.classList.add('hidden');dom.loginWrapper.classList.remove('hidden');dom.matriculaInput.value='';dom.senhaInput.value='';dom.loginAlert.classList.add('hidden'); if(refreshInterval) clearInterval(refreshInterval);}
            
            dom.themeToggle.addEventListener('click', () => applyTheme((localStorage.getItem('theme') || 'light') === 'light' ? 'dark' : 'light'));
            dom.loginButton.addEventListener('click',handleLogin); 
            dom.senhaInput.addEventListener('keypress',(e)=>e.key==='Enter'&&handleLogin());
            dom.toggleSenha.addEventListener('click', () => {
                const isPassword = dom.senhaInput.type === 'password';
                dom.senhaInput.type = isPassword ? 'text' : 'password';
                dom.toggleSenha.querySelector('i').className = `fas ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
            });
            dom.logoutButton.addEventListener('click',handleLogout);
            dom.searchInput.addEventListener('input', render);
            dom.filterControls.addEventListener('click',(e)=>{
                const button = e.target.closest('button');
                if (button) { 
                    currentFilter = button.dataset.filter; 
                    render();
                }
            });
            dom.refreshButton.addEventListener('click', () => loadDashboardData(true));
            dom.refreshSelect.addEventListener('change', setupAutoRefresh);
            dom.tableHead.addEventListener('click', handleSort);
            
            applyTheme(localStorage.getItem('theme') || 'light');
        });
    </script>
</body>
</html>
