<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Desempenho - Avaliação da Chefia - GCM Salvador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a56db; --primary-light: #eff6ff; --primary-dark: #0e2e71;
            --secondary: #ff9800; --light: #f3f4f6; --dark: #1f2937;
            --success: #10b981; --success-light: #f0fdf4; --danger: #ef4444;
            --warning: #f59e0b; --gray: #555e6b; /* Cor padronizada */ --border-color: #e5e7eb;
            --border-radius: 8px; 
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake-horizontal { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }
        @keyframes fadeInText { from { opacity: 0; } to { opacity: 1; } }
        .text-fade-in { animation: fadeInText 0.4s ease-in-out; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: #f5f7fa; color: var(--dark); line-height: 1.7; font-size: 16px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(90deg, #1a56db, #113a9b); color: white; padding: 1rem 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; animation: fadeIn 0.5s ease-out forwards; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px;}
        .hidden { display: none !important; }
        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08); }
        .btn:disabled { background-color: var(--gray); cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--gray); color: white; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 16px; transition: all 0.3s ease; }
        .password-wrapper { position: relative; }
        .password-wrapper input { padding-right: 45px; }
        .password-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--gray); }
        .toolbar { display: flex; gap: 15px; margin-top: 15px; margin-bottom: 15px; }
        .search-container { position: relative; flex-grow: 1; }
        .search-container input { padding-left: 35px; }
        .search-container .fa-search { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .btn-sort { background-color: #fff; color: var(--primary); border: 1px solid var(--primary); }
        .btn-sort.active { background-color: var(--primary); color: #fff; }
        .servidores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .servidor-card { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px; cursor: pointer; transition: all 0.3s; }
        .servidor-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary); }
        .servidor-card.concluido { background-color: #f9fafb; cursor: not-allowed; }
        .servidor-card.concluido:hover { transform: none; box-shadow: none; border-color: var(--border-color); }
        .servidor-card h3 { color: var(--primary-dark); margin-bottom: 10px; font-size: 1.1rem; }
        .servidor-card.concluido h3 { color: var(--gray); }
        .servidor-info { font-size: 0.9rem; color: var(--gray); }
        .status-badge { margin-top: 10px; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-block; font-weight: 600; }
        .status-pendente { background-color: var(--warning); color: white; }
        .status-concluido { background-color: var(--success); color: white; }
        .avaliacao-form { max-width: 800px; margin: 0 auto; padding: 0; }
        .criterio { margin-bottom: 25px; background-color: white; border-radius: var(--border-radius); border: 1px solid var(--border-color); overflow: hidden; padding: 0; transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out; }
        .criterio:not(.active-page) { display: none; }
        .criterio.active-criterio { box-shadow: 0 8px 25px rgba(26, 86, 219, 0.2); border-color: var(--primary); }
        .criterio h3 { color: white; background-color: var(--primary-dark); padding: 12px 20px; margin: 0; font-size: 1.1rem; }
        .questao { padding: 20px; background: white; transition: all 0.4s ease; border-left: 4px solid transparent; }
        .questao p { font-weight: 500; } /* Destaque para as perguntas */
        .questao + .questao { border-top: 1px solid var(--border-color); }
        .questao.questao-respondida { background-color: var(--success-light); border-left-color: var(--success); }
        .questao.invalid-question { background-color: #fee2e2; border-left-color: var(--danger); }
        .opcoes-avaliacao { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; }
        .opcao { text-align: center; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px; }
        .opcao .valor-numerico { font-size: 1.2rem; font-weight: bold; }
        .opcao .valor-texto { font-size: 0.75rem; color: var(--gray); margin-top: 4px; }
        .opcao:hover { background-color: var(--light); border-color: var(--primary); transform: translateY(-2px); }
        .opcao.selecionada { background-color: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .opcao.selecionada .valor-texto { color: white; }
        .opcao .valor-numerico::before { font-family: "Font Awesome 6 Free"; content: ""; font-weight: 900; margin-right: 8px; color: white; transition: content 0.2s ease; }
        .opcao.selecionada .valor-numerico::before { content: "\f00c"; }
        .declaracao-container { margin-top: 30px; border-top: 2px solid var(--border-color); padding-top: 20px; background-color: var(--light); padding: 20px; border-radius: var(--border-radius); border: 1px solid transparent; transition: border-color 0.3s; }
        .declaracao-container.invalid-question { border-color: var(--danger); }
        .declaracao-box { display: flex; align-items: flex-start; gap: 15px; }
        .declaracao-box input[type="checkbox"] { width: auto; margin-top: 5px; flex-shrink: 0; }
        .declaracao-box label { font-weight: normal; font-style: italic; color: var(--gray); line-height: 1.5; }
        .declaracao-box label strong { font-style: normal; color: var(--dark); }
        .alert { padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .resumo-pontuacao { background-color: var(--primary-light); padding: 15px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid var(--primary); }
        .progress-bar { height: 10px; background-color: var(--border-color); border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress { height: 100%; background-color: var(--primary); border-radius: 5px; transition: all 0.5s ease; }
        .instructions-panel { background-color: var(--primary-light); border: 1px solid var(--primary); border-radius: var(--border-radius); padding: 15px; margin-bottom: 20px; color: var(--primary-dark); }
        .instructions-panel h3 { font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card { background-color: var(--light); border-radius: var(--border-radius); padding: 15px; text-align: center; border-left: 5px solid var(--gray); }
        .stat-card h4 { font-size: 0.9rem; color: var(--gray); margin-bottom: 5px; text-transform: uppercase; }
        .stat-card p { font-size: 2rem; font-weight: 700; color: var(--dark); }
        .stat-card.stat-success { border-left-color: var(--success); }
        .stat-card.stat-warning { border-left-color: var(--warning); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 200; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background-color: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 450px; width: 90%; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { color: var(--primary-dark); margin-top: 0; margin-bottom: 15px; }
        .modal-content p { margin-bottom: 25px; font-size: 1.1rem; }
        .modal-content #modalScore { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .review-container { max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px; background-color: #f9fafb; }
        .review-item { border-bottom: 1px solid var(--border-color); padding: 10px 0; }
        .review-item:last-child { border-bottom: none; }
        .review-item p { margin: 0; font-size: 0.9rem; }
        .review-item span { font-weight: 600; color: var(--primary); background-color: var(--primary-light); padding: 2px 8px; border-radius: 10px; font-size: 1rem; }
        .stepper-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 20px; padding: 10px; background-color: var(--light); border-radius: var(--border-radius); position: relative; }
        .stepper-container::before { content: ''; position: absolute; top: 23px; left: 10%; right: 10%; height: 2px; background-color: var(--border-color); z-index: 0; }
        .step { display: flex; align-items: center; flex-direction: column; text-align: center; color: var(--gray); font-weight: 500; position: relative; z-index: 1; }
        .step-icon { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--gray); background-color: white; display: flex; justify-content: center; align-items: center; color: var(--gray); margin-bottom: 5px; transition: all 0.3s; }
        .step.active .step-icon { border-color: var(--primary); background-color: var(--primary); color: white; }
        .step.active .step-label { color: var(--primary); }
        .step.completed .step-icon { border-color: var(--success); background-color: var(--success); color: white; animation: pop 0.3s ease-out; }
        .step-label { font-size: 0.75rem; }
        .accordion-item { border-bottom: 1px solid var(--primary); }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header { background: none; border: none; width: 100%; text-align: left; padding: 12px 5px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--primary-dark); }
        .accordion-header::after { font-family: "Font Awesome 6 Free"; content: '\f078'; font-weight: 900; transition: transform 0.3s ease; }
        .accordion-header.active::after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .accordion-content-inner { padding: 5px 5px 15px; line-height: 1.8; }
        .accordion-content-inner ul { list-style-position: inside; padding-left: 5px; }
        .accordion-content-inner li + li { margin-top: 5px; }
        #successIcon { font-size: 4rem; color: var(--success); margin-bottom: 15px; display: inline-block; animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        body.dark-theme { --light: #334155; --dark: #f1f5f9; --border-color: #475569; background-color: #0f172a; }
        body.dark-theme .card, body.dark-theme .modal-content { background-color: #1e293b; border: 1px solid var(--border-color); }
        body.dark-theme .servidor-card { border-color: var(--border-color); }
        body.dark-theme .servidor-card:not(.concluido):hover { background-color: #34495e; }
        body.dark-theme .criterio, body.dark-theme .questao, body.dark-theme .declaracao-container, body.dark-theme .servidor-card.concluido, body.dark-theme .stepper-container { background-color: #1e293b; border-color: var(--border-color); }
        body.dark-theme input, body.dark-theme select, body.dark-theme textarea, body.dark-theme .opcao:hover { background-color: #34495e; border-color: #4a627a; color: var(--dark); }
        body.dark-theme .status-pendente { background-color: #f59e0b; color: #1f2937; }
        body.dark-theme .status-concluido { background-color: #10b981; color: white; }
        body.dark-theme .instructions-panel, body.dark-theme .stat-card, body.dark-theme .review-container { background-color: var(--light); border-color: var(--primary); color: var(--dark); }
        body.dark-theme .stat-card p, body.dark-theme .servidor-card.concluido h3 { color: var(--dark); }
        body.dark-theme .review-item span { color: white; background-color: var(--primary); }
        body.dark-theme .questao.invalid-question { background-color: #5f2a2a; }
        body.dark-theme .opcao.selecionada .valor-texto { color: #f0fdf4; }
        body.dark-theme .accordion-header { color: var(--dark); }
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: var(--border-radius); color: white; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; animation: slideInRight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        .toast.toast-success { background-color: var(--success); }
        .toast.toast-info { background-color: var(--primary); }
        .toast.toast-error { background-color: var(--danger); }
        .toast.toast-hiding { animation: fadeOut 0.5s ease-out forwards; }
        .input-error-flash { border-color: var(--danger) !important; animation: shake-horizontal 0.4s cubic-bezier(.455,.03,.515,.955) both; }
        @media (max-width: 768px) { .servidores-grid { grid-template-columns: 1fr; } .opcoes-avaliacao { grid-template-columns: repeat(2, 1fr); } .header-content, .card-header { flex-direction: column; gap: 10px; align-items: flex-start; } .toolbar { flex-direction: column; } }
        @media (max-width: 480px) { #toastContainer { right: 10px; left: 10px; top: 10px; } .modal-buttons { flex-direction: column; gap: 10px; } }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo"><i class="fas fa-shield-alt fa-2x"></i><h1>Sistema de Avaliação de Desempenho - Avaliação da Chefia - GCM Salvador</h1></div>
            <div id="userInfo" class="user-info hidden">
                <span id="userName"></span>
                <button id="themeToggle" class="btn btn-secondary" style="background-color: transparent; border: 1px solid white;">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="btnLogout" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="loginScreen" class="card">
            <h2>Acesso Restrito da Chefia</h2>
            <div class="instructions-panel">
                <h3><i class="fas fa-info-circle"></i> Orientações sobre a Avaliação de Chefia</h3>
                <div class="accordion">
                    <div class="accordion-item">
                        <button class="accordion-header">Requisito Legal e Período</button>
                        <div class="accordion-content"><div class="accordion-content-inner"><ul>
                            <li><strong>Requisito Legal:</strong> Conforme a <strong>Lei Municipal nº 9.640/2022</strong>, a Avaliação de Desempenho é um requisito fundamental para o desenvolvimento na carreira dos servidores.</li>
                            <li><strong>Período para Avaliar:</strong> A avaliação dos servidores da sua equipe estará disponível entre os dias <strong>02 e 21 de outubro</strong>.</li>
                        </ul></div></div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">Acesso e Sistema</button>
                        <div class="accordion-content"><div class="accordion-content-inner"><ul>
                            <li><strong>Picos de Acesso:</strong> É esperado um grande volume de acessos nos primeiros e últimos dias. Caso o sistema apresente <strong>lentidão ou erro genérico</strong>, por favor, tente novamente em um horário de menor movimento.</li>
                            <li><strong>Acesso Inválido:</strong> Se a mensagem for <strong>'matrícula ou senha inválida'</strong>, verifique os dados com atenção. Persistindo, contate o setor responsável.</li>
                        </ul></div></div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">Casos Específicos de Servidores</button>
                        <div class="accordion-content"><div class="accordion-content-inner"><ul>
                            <li><strong>Servidores Cedidos:</strong> Conforme o <strong>Decreto nº 38.473/2024 (Art. 31)</strong>, servidores cedidos não recebem avaliação da chefia (nota 100% da autoavaliação).</li>
                            <li><strong>Mandato Classista (Sindicato):</strong> Conforme o <strong>Art. 32 do Decreto nº 38.473/2024</strong>, servidores afastados para mandato classista estão <strong>dispensados</strong> da avaliação e não aparecerão na sua lista.</li>
                        </ul></div></div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">Servidores Inaptos e Afastamentos</button>
                        <div class="accordion-content"><div class="accordion-content-inner"><ul>
                            <li><strong>Servidores Inaptos:</strong> De acordo com o <strong>Art. 47 da Lei nº 9.640/2022</strong>, servidores em afastamentos como <strong>Licença para Tratar de Interesses Particulares</strong> ou <strong>Licença Saúde (+60 dias)</strong> não aparecerão na sua lista.</li>
                            <li><strong>Afastamentos que NÃO Impedem:</strong> Períodos de <strong>Férias</strong>, <strong>Licença-Prêmio</strong> e <strong>Licença Maternidade/Adoção</strong> não impedem a avaliação.</li>
                        </ul></div></div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header" style="color: var(--danger);">Responsabilidade e Fundamentação</button>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <ul>
                                    <li><strong>A Avaliação de Desempenho</strong> é um ato administrativo formal que deve obedecer estritamente aos princípios da legalidade, impessoalidade, moralidade, publicidade e eficiência, conforme previsto no <strong>(Art. 43 da Lei nº 9.640/2022 e no Art. 5º do Decreto nº 38.473/2024)</strong>. Notas que não reflitam o desempenho profissional real, baseadas em fatos concretos, são passíveis de anulação.</li>
                                    <li><strong>É direito do servidor</strong> solicitar um pedido de reconsideração contra o resultado no prazo de <strong>10 dias</strong> <strong>(Art. 45 da Lei nº 9.640/2022)</strong>. Em caso de recurso, a comissão recursal poderá solicitar que o chefe avaliador apresente as justificativas para a pontuação aplicada <strong>(Art. 22 do Decreto nº 38.473/2024)</strong>, transferindo a ele o ônus da prova. Essa comprovação deve ser objetiva, baseada em <strong>fatos e registros formais</strong> <strong>(como folhas de ponto, relatórios, advertências documentadas, e-mails, etc.)</strong>, e não em <strong>observações pessoais não formalizadas</strong>, para garantir o princípio da Impessoalidade.</li>
                                    <li><strong>Avaliações infundadas, desproporcionais ou utilizadas como ferramenta de perseguição</strong> configuram abuso ou desvio de poder, uma violação dos deveres do servidor público. Tais atos sujeitam o avaliador à responsabilidade administrativa <strong>(Arts. 165 e 168 da Lei Complementar nº 01/1991)</strong>, podendo levar à abertura de processo disciplinar para apurar a conduta.</li>
                                    <li><strong>Lembre-se que, como servidor público,</strong> é seu dever representar contra ilegalidades e zelar pela moralidade administrativa <strong>(Art. 160 da Lei Complementar nº 01/1991)</strong>. O uso do cargo para lograr proveito pessoal ou prejudicar subordinados é uma infração grave. Avalie com máxima seriedade e imparcialidade, pois sua conduta como avaliador será examinada com base na legislação em caso de contestação.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">Instruções Finais</button>
                        <div class="accordion-content"><div class="accordion-content-inner"><ul>
                           <li><strong>Revisão Final:</strong> Antes de finalizar, uma tela de revisão será exibida. Confira com atenção, pois o envio da avaliação é definitivo.</li>
                           <li><strong>Ação Definitiva:</strong> Lembre-se, uma avaliação enviada <strong>não poderá ser editada</strong>.</li>
                           <li><strong>Publicação do Resultado:</strong> O resultado final será publicado em Diário Oficial do Município <strong>(Art. 43 da Lei nº 9.640/2022)</strong>.</li>
                        </ul></div></div>
                    </div>
                </div>
            </div>
            <div id="loginAlert" class="alert alert-error hidden"></div>
            <div class="form-group"><label for="matricula">Matrícula:</label><input type="text" id="matricula" placeholder="Digite sua matrícula SIGP" inputmode="numeric"></div>
            <div class="form-group">
                <label for="senha">Senha (CPF Somente Números):</label>
                <div class="password-wrapper">
                    <input type="password" id="senha" placeholder="Digite seu CPF (apenas números)" inputmode="numeric">
                    <i class="fas fa-eye" id="togglePassword"></i>
                </div>
            </div>
            <button id="btnLogin" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            <div id="loginLoading" class="hidden" style="text-align: center; margin-top: 15px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i><p style="margin-top: 10px;">Validando credenciais...</p>
            </div>
        </div>

        <div id="servidoresScreen" class="card hidden">
            <div class="card-header">
                <div>
                    <h2>Servidores sob sua supervisão</h2>
                    <p>Selecione um servidor para iniciar ou consultar a avaliação.</p>
                </div>
            </div>
            <div id="dashboard" style="margin: 20px 0;">
                <div class="dashboard-stats">
                    <div class="stat-card"><h4>Total</h4><p id="statTotal">0</p></div>
                    <div class="stat-card stat-success"><h4>Avaliados</h4><p id="statAvaliados">0</p></div>
                    <div class="stat-card stat-warning"><h4>Pendentes</h4><p id="statPendentes">0</p></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="search-container"><i class="fas fa-search"></i><input type="text" id="searchServidor" placeholder="Pesquisar por nome ou matrícula..."></div>
                <button id="btnSortStatus" class="btn btn-sort"><i class="fas fa-filter"></i> Ordenar por Status</button>
            </div>
            <div id="servidoresList" class="servidores-grid"></div>
        </div>

        <div id="avaliacaoScreen" class="card avaliacao-form hidden">
            <div class="card-header"><h2>Avaliação de Desempenho</h2><button id="btnVoltarLista" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar à Lista</button></div>
            <div id="stepper" class="stepper-container"></div>
            <div style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                <p><b>Avaliado:</b> <strong id="avaliadoNome"></strong></p>
                <p><b>Matrícula:</b> <strong id="avaliadoMatricula"></strong></p>
                <p><b>Lotação:</b> <strong id="avaliadoLotacao"></strong></p>
            </div>
            <div id="avaliacaoAlert" class="alert alert-error hidden"></div>
            <form id="formAvaliacao" onsubmit="return false;">
                <input type="hidden" id="matriculaAvaliado"><input type="hidden" id="nomeAvaliado">
                <div class="criterio" id="criterio-produtividade"><h3>PRODUTIVIDADE E METAS</h3><div class="questao" id="q-1"><p>1- Procura novos conhecimentos que contribuam para o desenvolvimento dos trabalhos.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao1"></div><div class="questao" id="q-2"><p>2- Coloca-se à disposição da chefia, espontaneamente, para aprender novas técnicas e auxiliar os colegas.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao2"></div><div class="questao" id="q-3"><p>3- É hábil em identificar e apresentar soluções para os problemas que surjam no trabalho.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao3"></div><div class="questao" id="q-4"><p>4- Zela pelo próprio preparo profissional e incentiva os companheiros a fazerem o mesmo, em prol do cumprimento da missão comum.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao4"></div><div class="questao" id="q-5"><p>5- Quando ofertado, participa de cursos, palestras, atividades, dinâmicas que contribuam para o seu desenvolvimento profissional na instituição.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao5"></div></div>
                <div class="criterio" id="criterio-responsabilidade"><h3>RESPONSABILIDADE</h3><div class="questao" id="q-6"><p>6- É comprometido com o seu trabalho, atuando com prudência, firmeza e efetividade na sua área de responsabilidade.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao6"></div><div class="questao" id="q-7"><p>7- Cumpre as normas, as regras e os regulamentos das legislações vigentes.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao7"></div><div class="questao" id="q-8"><p>8- Respeita a hierarquia, obedecendo fielmente as ordens de seus superiores, desde que legais.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao8"></div><div class="questao" id="q-9"><p>9- Mantem sigilo sobre os assuntos internos da Guarda Municipal ou de matéria confidencial que possam de alguma forma expor o outro.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao9"></div><div class="questao" id="q-10"><p>10- Auxilia colegas de trabalho, mantendo um ambiente de cooperação e harmonia.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao10"></div></div>
                <div class="criterio" id="criterio-pontualidade"><h3>PONTUALIDADE</h3><div class="questao" id="q-11"><p>11- Cumpre o horário de trabalho, respeitando o horário de entrada e saída.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="2.0"><span class="valor-numerico">2,0</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="3.0"><span class="valor-numerico">3,0</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="4.0"><span class="valor-numerico">4,0</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="5.0"><span class="valor-numerico">5,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao11"></div></div>
                <div class="criterio" id="criterio-assiduidade"><h3>ASSIDUIDADE</h3><div class="questao" id="q-12"><p>12- Comparece regularmente ao local de trabalho.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao12"></div><div class="questao" id="q-13"><p>13- Comunica previamente à chefia imediata, sempre que possível, as suas eventuais ausências.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao13"></div><div class="questao" id="q-14"><p>14- Evita ausentar-se do trabalho para tratar de assuntos particulares, sem o prévio conhecimento da chefia imediata.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao14"></div><div class="questao" id="q-15"><p>15- Mantém postura colaboradora, contribuindo para o bom andamento do serviço e para o alcance dos objetivos.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao15"></div><div class="questao" id="q-16"><p>16- Cuida da apresentação pessoal, utilizando uniforme e equipamentos adequados, limpos e bem conservados.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.2"><span class="valor-numerico">0,2</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="0.4"><span class="valor-numerico">0,4</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="0.6"><span class="valor-numerico">0,6</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="0.8"><span class="valor-numerico">0,8</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao16"></div></div>
                <div class="criterio" id="criterio-equipamentos"><h3>USO ADEQUADO DOS EQUIPAMENTOS</h3><div class="questao" id="q-17"><p>17- Zela pelos equipamentos de trabalho (viaturas, armamentos, EPIs, etc.), utilizando-os de forma adequada e segura.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.5"><span class="valor-numerico">0,5</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="1.5"><span class="valor-numerico">1,5</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="2.0"><span class="valor-numerico">2,0</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="2.5"><span class="valor-numerico">2,5</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao17"></div><div class="questao" id="q-18"><p>18- Domina tecnologias e ferramentas necessárias para o exercício de suas atribuições.</p><div class="opcoes-avaliacao"><div class="opcao" data-value="0.5"><span class="valor-numerico">0,5</span><span class="valor-texto">Abaixo do Esperado</span></div><div class="opcao" data-value="1.0"><span class="valor-numerico">1,0</span><span class="valor-texto">Regular</span></div><div class="opcao" data-value="1.5"><span class="valor-numerico">1,5</span><span class="valor-texto">Bom</span></div><div class="opcao" data-value="2.0"><span class="valor-numerico">2,0</span><span class="valor-texto">Muito Bom</span></div><div class="opcao" data-value="2.5"><span class="valor-numerico">2,5</span><span class="valor-texto">Excelente</span></div></div><input type="hidden" id="questao18"></div></div>
                
                <div class="resumo-pontuacao">
                    <h3>Resumo de Pontuação</h3>
                    <div class="progress-bar"><div id="progressBar" class="progress" style="width: 0%"></div></div>
                    <p>Pontuação Atual: <strong id="pontuacaoAtual">0,0 / 25,0 pts</strong></p>
                    <p>Desempenho: <strong id="faixaDesempenho"></strong></p>
                </div>

                <div id="declarationBoxWrapper" class="hidden">
                    <div class="declaracao-container">
                        <h3>Declaração de Veracidade</h3>
                        <div class="declaracao-box">
                            <input type="checkbox" id="checkDeclaracao">
                            <label for="checkDeclaracao">
                                Eu, <strong><span id="declaracaoNome"></span></strong>, matrícula nº <strong><span id="declaracaoMatricula"></span></strong>, 
                                declaro sob as penas da lei que as informações prestadas nesta avaliação do servidor <strong><span id="declaracaoNomeAvaliado"></span></strong>, matrícula nº <strong><span id="declaracaoMatriculaAvaliado"></span></strong>, são verdadeiras e correspondem à minha justa observação de seu desempenho.
                            </label>
                        </div>
                        <small style="color: var(--gray); font-style: italic; display: block; margin-top: 5px;">
                            Campo obrigatório para envio da avaliação
                        </small>
                    </div>
                </div>

                <div id="paginationControls" style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; display: flex; justify-content: space-between;">
                    <button type="button" id="prevButton" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button type="button" id="nextButton" class="btn btn-primary">Próximo <i class="fas fa-arrow-right"></i></button>
                    <button type="submit" id="btnSalvarAvaliacao" class="btn btn-success hidden"><i class="fas fa-check-circle"></i> Finalizar Avaliação</button>
                </div>
            </form>
        </div>
    </div>
    <div id="reviewModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="reviewModalTitle">
        <div class="modal-content" style="max-width: 700px; text-align: left;">
            <h3 id="reviewModalTitle">Revisão Final da Avaliação</h3>
            <p>Por favor, confira todas as respostas abaixo. Após a confirmação, a avaliação não poderá ser alterada.</p>
            <div id="reviewContent" class="review-container"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button id="modalCloseReview" class="btn btn-secondary"><i class="fas fa-edit"></i> Voltar e Corrigir</button>
                <button id="modalConfirmReview" class="btn btn-success"><i class="fas fa-check"></i> Confirmar e Enviar</button>
            </div>
        </div>
    </div>
    <div id="confirmationModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
        <div class="modal-content">
            <h3 id="confirmationModalTitle">Confirmar Envio</h3>
            <p>A pontuação final do servidor é de <span id="modalScore"></span> pontos.</p>
            <p>Deseja confirmar o envio desta avaliação?</p>
            <div class="modal-buttons">
                <button id="modalCancel" class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                <button id="modalConfirm" class="btn btn-success"><i class="fas fa-check"></i> Confirmar Envio</button>
            </div>
        </div>
    </div>
    <div id="successModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="successModalTitle">
        <div class="modal-content">
            <i id="successIcon" class="fas fa-check-circle"></i>
            <h3 id="successModalTitle">Avaliação Enviada!</h3>
            <p id="successModalMessage"></p>
            <div class="modal-buttons">
                <button id="successModalClose" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    <div id="infoModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
        <div class="modal-content">
            <h3 id="infoModalTitle">Atenção</h3>
            <p id="infoModalMessage"></p>
            <div class="modal-buttons">
                <button id="infoModalClose" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    <button id="backToTopBtn" class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px; display: none; border-radius: 50%; width: 50px; height: 50px; justify-content: center; z-index: 150;" title="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>
    <div id="toastContainer"></div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzRl3kqgG_qsGsj_NTVoRHZQjwQMpQooPmzzMYhEEmsOAtLHd0Co1nMkmF7RRAavp20gw/exec";
        
        const sections = [
            { id: 'produtividade', title: 'Produtividade', questions: ['questao1', 'questao2', 'questao3', 'questao4', 'questao5'] },
            { id: 'responsabilidade', title: 'Responsabilidade', questions: ['questao6', 'questao7', 'questao8', 'questao9', 'questao10'] },
            { id: 'pontualidade', title: 'Pontualidade', questions: ['questao11'] },
            { id: 'assiduidade', title: 'Assiduidade', questions: ['questao12', 'questao13', 'questao14', 'questao15', 'questao16'] },
            { id: 'equipamentos', title: 'Equipamentos', questions: ['questao17', 'questao18'] }
        ];
        
        const dom = {
            login: { screen: document.getElementById('loginScreen'), alert: document.getElementById('loginAlert'), matricula: document.getElementById('matricula'), senha: document.getElementById('senha'), togglePass: document.getElementById('togglePassword'), loading: document.getElementById('loginLoading') },
            servidores: { screen: document.getElementById('servidoresScreen'), list: document.getElementById('servidoresList') },
            avaliacao: { screen: document.getElementById('avaliacaoScreen'), alert: document.getElementById('avaliacaoAlert'), stepper: document.getElementById('stepper'), form: document.getElementById('formAvaliacao'), declarationBoxWrapper: document.getElementById('declarationBoxWrapper'), submitBtn: document.getElementById('btnSalvarAvaliacao') },
            userInfo: document.getElementById('userInfo'),
            userName: document.getElementById('userName'),
            successModal: { el: document.getElementById('successModal'), message: document.getElementById('successModalMessage'), closeBtn: document.getElementById('successModalClose') },
            reviewModal: document.getElementById('reviewModal'),
            confirmationModal: document.getElementById('confirmationModal'),
            infoModal: document.getElementById('infoModal'),
            pagination: { prevButton: document.getElementById('prevButton'), nextButton: document.getElementById('nextButton') }
        };

        let currentUser = null, servidores = [], avaliacoes = [], sortByPending = false, isFormDirty = false, currentPageIndex = 0;
        const moonIcon = '<i class="fas fa-moon"></i>';
        const sunIcon = '<i class="fas fa-sun"></i>';
        
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'fa-check-circle', info: 'fa-info-circle', error: 'fa-exclamation-circle' };
            toast.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        }

        function showAlert(el, msg, type) { el.textContent = msg; el.className = `alert alert-${type}`; el.classList.remove('hidden'); }
        function hideAlert(el) { el.classList.add('hidden'); }
        function showScreen(el) { el.classList.remove('hidden'); }
        function hideScreen(el) { el.classList.add('hidden'); }

        function showModal(modalElement) {
            modalElement.classList.add('visible');
            const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusableElements.length > 0) {
                const firstElement = focusableElements[0];
                firstElement.focus();
                modalElement.addEventListener('keydown', function(e) {
                    if (e.key !== 'Tab') return;
                    const lastElement = focusableElements[focusableElements.length - 1];
                    if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } }
                    else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } }
                });
            }
        }

        function hideModal(modalElement) { modalElement.classList.remove('visible'); }
        
        function applyTheme(theme) {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            document.getElementById('themeToggle').innerHTML = theme === 'dark' ? sunIcon : moonIcon;
            localStorage.setItem('theme', theme);
        }

        function showLoginScreen() {
            [dom.servidores.screen, dom.avaliacao.screen, dom.userInfo].forEach(hideScreen);
            showScreen(dom.login.screen);
            dom.login.matricula.value = ''; dom.login.senha.value = ''; hideAlert(dom.login.alert);
        }

        function showServidoresScreen() {
            isFormDirty = false;
            [dom.login.screen, dom.avaliacao.screen].forEach(hideScreen);
            [dom.servidores.screen, dom.userInfo].forEach(showScreen);
            dom.userName.textContent = currentUser.nome;
            const searchInput = document.getElementById('searchServidor');
            if (searchInput) searchInput.value = '';
            window.scrollTo(0, 0);
        }

        function logout() {
            showToast('Logout efetuado com sucesso.', 'info');
            isFormDirty = false; localStorage.removeItem('avaliacao_user'); showLoginScreen();
        }

        function login() {
            const m = dom.login.matricula, s = dom.login.senha, b = document.getElementById('btnLogin');
            if (!m.value || !s.value) return showAlert(dom.login.alert, 'Preencha todos os campos.', 'error');
            b.disabled = true; b.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...'; dom.login.loading.classList.remove('hidden');
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', matricula: m.value, senha: s.value }) })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentUser = data.user; localStorage.setItem('avaliacao_user', JSON.stringify(currentUser));
                    showServidoresScreen(); loadServidores();
                    showToast(`Bem-vindo(a), ${currentUser.nome.split(' ')[0]}!`, 'success');
                } else { showAlert(dom.login.alert, data.error, 'error'); }
            })
            .catch(err => showAlert(dom.login.alert, 'Erro de comunicação.', 'error'))
            .finally(() => { b.disabled = false; b.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar'; dom.login.loading.classList.add('hidden'); });
        }
        
        function loadServidores() {
            dom.servidores.list.innerHTML = '<p>Carregando servidores...</p>';
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getServidores', matriculaAvaliador: currentUser.matricula }) })
            .then(res => res.json())
            .then(data => {
                if (data.success) { 
                    servidores = data.servidores; 
                    avaliacoes = data.avaliacoes; 
                    renderServidores(); 
                    updateDashboard(); 
                } else { 
                    dom.servidores.list.innerHTML = `<p style="color: red;">${data.error}</p>`; 
                }
            }).catch(err => {
                console.error("Falha ao carregar servidores:", err);
                dom.servidores.list.innerHTML = '<p style="color: red;">Erro de comunicação.</p>';
            });
        }
        
        function updateDashboard() {
            const total = servidores.length;
            const avaliados = avaliacoes.length;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statAvaliados').textContent = avaliados;
            document.getElementById('statPendentes').textContent = total - avaliados;
        }

        // *** FUNÇÃO CORRIGIDA PARA USAR A LÓGICA ORIGINAL E FUNCIONAL ***
        function renderServidores() {
            const searchTerm = document.getElementById('searchServidor').value.toLowerCase().trim();
            let servidoresFiltrados = servidores.filter(s => s.nome.toLowerCase().includes(searchTerm) || s.matricula.toString().includes(searchTerm));
            if (sortByPending) {
                servidoresFiltrados.sort((a, b) => {
                    const aAvaliado = avaliacoes.some(av => av.matriculaAvaliado === a.matricula);
                    const bAvaliado = avaliacoes.some(av => av.matriculaAvaliado === b.matricula);
                    return aAvaliado - bAvaliado;
                });
            }
            dom.servidores.list.innerHTML = '';
            // A linha abaixo estava no arquivo original, a removermos pois não há o elemento com ID 'progressoContador'
            // document.getElementById('progressoContador').innerHTML = `<strong>${avaliacoes.length} de ${servidores.length}</strong> avaliados`;
            if (servidoresFiltrados.length === 0) { dom.servidores.list.innerHTML = '<p>Nenhum servidor encontrado.</p>'; return; }
            servidoresFiltrados.forEach(servidor => {
                const avaliacao = avaliacoes.find(av => av.matriculaAvaliado === servidor.matricula);
                const status = avaliacao ? 'concluido' : 'pendente';
                const card = document.createElement('div');
                card.className = `servidor-card ${status}`;
                // *** A linha abaixo foi revertida para a original para evitar erros ***
                card.innerHTML = `<h3>${servidor.nome}</h3><div class="servidor-info"><p>Matrícula: ${servidor.matricula}</p><p>Lotação: ${servidor.lotacao}</p></div><div class="status-badge status-${status}">${avaliacao ? 'Avaliado' : 'Pendente'}</div>`;
                card.addEventListener('click', () => {
                    if (avaliacao) { showInfoModal("Esta avaliação já foi concluída e não pode ser editada."); }
                    else { showAvaliacaoScreen(servidor); }
                });
                dom.servidores.list.appendChild(card);
            });
        }
        
        function generateStepper() {
            dom.avaliacao.stepper.innerHTML = sections.map((section, index) =>
                `<div class="step" id="step-${section.id}" data-index="${index}" style="cursor: pointer;">
                    <div class="step-icon">${index + 1}</div>
                    <div class="step-label">${section.title}</div>
                 </div>`
            ).join('');
            addStepperNavigation();
        }
        
        function addStepperNavigation() {
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    if (index < currentPageIndex || validateCurrentPage()) {
                        currentPageIndex = index; showPage(currentPageIndex);
                    } else {
                        showToast('Responda todas as questões desta página para avançar.', 'error', 3000);
                    }
                });
            });
        }
        
        function showAvaliacaoScreen(servidor) {
            hideScreen(dom.servidores.screen); showScreen(dom.avaliacao.screen);
            window.scrollTo(0, 0);
            ['avaliadoNome', 'declaracaoNomeAvaliado'].forEach(id => document.getElementById(id).textContent = servidor.nome);
            ['avaliadoMatricula', 'declaracaoMatriculaAvaliado'].forEach(id => document.getElementById(id).textContent = servidor.matricula);
            document.getElementById('avaliadoLotacao').textContent = servidor.lotacao;
            document.getElementById('matriculaAvaliado').value = servidor.matricula;
            document.getElementById('nomeAvaliado').value = servidor.nome;
            document.getElementById('declaracaoNome').textContent = currentUser.nome;
            document.getElementById('declaracaoMatricula').textContent = currentUser.matricula;
            
            dom.avaliacao.form.reset();
            document.getElementById('checkDeclaracao').checked = false;
            for (let i = 1; i <= 18; i++) {
                const hiddenInput = document.getElementById(`questao${i}`);
                if (hiddenInput) hiddenInput.value = '';
            }
            document.querySelectorAll('.opcao').forEach(op => op.classList.remove('selecionada'));
            document.querySelectorAll('.questao').forEach(q => q.classList.remove('questao-respondida', 'invalid-question'));
            hideAlert(dom.avaliacao.alert);
            
            calcularPontuacao();
            currentPageIndex = 0; 
            showPage(currentPageIndex);
        }

        function calcularPontuacao() {
            let total = 0;
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`questao${i}`);
                if (input && input.value) { total += parseFloat(input.value); }
            }
            const totalFormatado = total.toFixed(1).replace('.', ',');
            document.getElementById('pontuacaoAtual').textContent = `${totalFormatado} / 25,0 pts`;
            document.getElementById('progressBar').style.width = ((total / 25.0) * 100) + '%';
            
            let faixa = "Abaixo do Esperado", cor = 'var(--danger)';
            const scorePercentage = (total / 25.0) * 100;
            if (scorePercentage >= 91) { faixa = "Excelente"; cor = 'var(--success)'; }
            else if (scorePercentage >= 82) { faixa = "Muito Bom"; cor = 'var(--success)'; }
            else if (scorePercentage >= 73) { faixa = "Bom"; cor = 'var(--success)'; }
            else if (scorePercentage >= 64) { faixa = "Regular"; cor = 'var(--primary)'; }
            
            document.getElementById('progressBar').style.backgroundColor = cor;
            const faixaEl = document.getElementById('faixaDesempenho');
            if(faixaEl.textContent !== faixa) {
                faixaEl.classList.remove('text-fade-in');
                void faixaEl.offsetWidth; // Trigger reflow
                faixaEl.textContent = faixa;
                faixaEl.classList.add('text-fade-in');
            }
            
            sections.forEach(section => {
                const isCompleted = section.questions.every(qId => document.getElementById(qId) && document.getElementById(qId).value);
                const stepEl = document.getElementById(`step-${section.id}`);
                if (stepEl) stepEl.classList.toggle('completed', isCompleted);
            });
            return total;
        }

        function validateForm() {
            let isFormValid = true;
            document.querySelectorAll('.declaracao-container').forEach(el => el.classList.remove('invalid-question'));
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`questao${i}`);
                const qDiv = document.getElementById(`q-${i}`);
                if (qDiv) qDiv.classList.remove('invalid-question');
                if (!input || !input.value) {
                    isFormValid = false; 
                    if(qDiv) qDiv.classList.add('invalid-question');
                }
            }
            if (!document.getElementById('checkDeclaracao').checked) {
                isFormValid = false; document.querySelector('.declaracao-container').classList.add('invalid-question');
            }
            return isFormValid;
        }

        function handleFormSubmitAttempt(e) {
            e.preventDefault(); hideAlert(dom.avaliacao.alert);
            if (!validateForm()) {
                showAlert(dom.avaliacao.alert, 'Responda todas as questões e marque a declaração para finalizar.', 'error');
                const firstInvalid = document.querySelector('.invalid-question');
                if (firstInvalid) {
                    const invalidCriterio = firstInvalid.closest('.criterio');
                    if (invalidCriterio) {
                        const invalidIndex = sections.findIndex(sec => `criterio-${sec.id}` === invalidCriterio.id);
                        if (invalidIndex !== -1) { currentPageIndex = invalidIndex; showPage(currentPageIndex); }
                    }
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            showReview();
        }
        
        function showReview() {
            const reviewContent = document.getElementById('reviewContent');
            reviewContent.innerHTML = `<p style="margin-bottom:15px; text-align:center;"><strong>Servidor:</strong> ${document.getElementById('avaliadoNome').textContent} | <strong>Matrícula:</strong> ${document.getElementById('avaliadoMatricula').textContent}</p>`;
            for (let i = 1; i <= 18; i++) {
                const questaoTexto = document.querySelector(`#q-${i} p`).textContent;
                const respostaValor = document.getElementById(`questao${i}`).value;
                reviewContent.innerHTML += `<div class="review-item"><p>${questaoTexto}</p><p>Sua nota: <span>${respostaValor.replace('.',',')}</span></p></div>`;
            }
            showModal(dom.reviewModal);
        }

        function submitEvaluation() {
            hideModal(dom.confirmationModal);
            const pontuacaoTotal = calcularPontuacao();
            const respostas = {}; 
            for (let i = 1; i <= 18; i++) { 
                respostas[`questao${i}`] = parseFloat(document.getElementById(`questao${i}`).value) || 0; 
            }
            const avaliacaoData = {
                matriculaAvaliador: currentUser.matricula, nomeAvaliador: currentUser.nome,
                matriculaAvaliado: document.getElementById('matriculaAvaliado').value, nomeAvaliado: document.getElementById('nomeAvaliado').value,
                pontuacao: pontuacaoTotal,
                declaracao: `Confirmado por ${currentUser.nome} em ${new Date().toLocaleString('pt-BR')}`, 
                respostas: respostas
            };
            const btnSalvar = dom.avaliacao.submitBtn;
            btnSalvar.disabled = true; btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            isFormDirty = false;
            
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'salvarAvaliacao', avaliacao: avaliacaoData }) })
                .then(res => {
                    if (!res.ok) throw new Error(`Erro no servidor: ${res.status}`);
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        dom.successModal.message.innerHTML = `A avaliação de <strong>${avaliacaoData.nomeAvaliado}</strong> foi enviada com sucesso.`;
                        showModal(dom.successModal.el);
                    } else { 
                        showAlert(dom.avaliacao.alert, data.error, 'error'); 
                    }
                })
                .catch(err => showAlert(dom.avaliacao.alert, `Erro de comunicação: ${err.message}`, 'error'))
                .finally(() => { 
                    btnSalvar.disabled = false; 
                    btnSalvar.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Avaliação'; 
                });
        }
        
        function showInfoModal(message) {
            document.getElementById('infoModalMessage').textContent = message; showModal(dom.infoModal);
        }
        
        function validateCurrentPage() {
            let isPageValid = true;
            const currentSection = sections[currentPageIndex];
            currentSection.questions.forEach(qId => {
                const input = document.getElementById(qId);
                const questaoDiv = document.getElementById(`q-${qId.replace('questao', '')}`);
                if (!input || !input.value) { isPageValid = false; questaoDiv.classList.add('invalid-question'); }
                else { questaoDiv.classList.remove('invalid-question'); }
            });
            return isPageValid;
        }

        function showPage(index) {
            document.querySelectorAll('.criterio').forEach(c => c.classList.remove('active-page'));
            document.getElementById(`criterio-${sections[index].id}`).classList.add('active-page');
            dom.pagination.prevButton.disabled = index === 0;
            const isLastPage = index === sections.length - 1;
            dom.pagination.nextButton.classList.toggle('hidden', isLastPage);
            dom.avaliacao.submitBtn.classList.toggle('hidden', !isLastPage);
            dom.avaliacao.declarationBoxWrapper.classList.toggle('hidden', !isLastPage);
            document.querySelectorAll('.step.active').forEach(s => s.classList.remove('active'));
            const activeStep = document.getElementById(`step-${sections[index].id}`);
            if (activeStep) activeStep.classList.add('active');
            const title = document.querySelector(`#criterio-${sections[index].id} h3`);
            if(title) { title.focus({ preventScroll: true }); window.scrollTo(0, dom.avaliacao.screen.offsetTop); }
        }

        const filterNumericInput = (event) => {
            const inputElement = event.target;
            const originalValue = inputElement.value;
            const sanitizedValue = originalValue.replace(/[^0-9]/g, '');
            if (originalValue !== sanitizedValue) {
                inputElement.classList.add('input-error-flash');
                setTimeout(() => { inputElement.classList.remove('input-error-flash'); }, 500);
            }
            inputElement.value = sanitizedValue;
        };

        const savedUser = localStorage.getItem('avaliacao_user');
        if (savedUser) { currentUser = JSON.parse(savedUser); showServidoresScreen(); loadServidores(); }
        
        document.getElementById('btnLogin').addEventListener('click', login);
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('btnVoltarLista').addEventListener('click', () => showServidoresScreen());
        dom.avaliacao.form.addEventListener('submit', handleFormSubmitAttempt);
        document.getElementById('searchServidor').addEventListener('keyup', renderServidores);
        document.getElementById('btnSortStatus').addEventListener('click', function() { sortByPending = !sortByPending; this.classList.toggle('active'); renderServidores(); });
        document.getElementById('modalConfirm').addEventListener('click', submitEvaluation);
        document.getElementById('modalCancel').addEventListener('click', () => hideModal(dom.confirmationModal));
        document.getElementById('infoModalClose').addEventListener('click', () => hideModal(dom.infoModal));
        document.getElementById('modalCloseReview').addEventListener('click', () => hideModal(dom.reviewModal));
        document.getElementById('modalConfirmReview').addEventListener('click', () => { hideModal(dom.reviewModal); document.getElementById('modalScore').textContent = calcularPontuacao().toFixed(1).replace('.', ','); showModal(dom.confirmationModal); });
        dom.login.togglePass.addEventListener('click', () => { const s = dom.login.senha; s.type = s.type === 'password' ? 'text' : 'password'; dom.login.togglePass.classList.toggle('fa-eye-slash'); dom.login.togglePass.classList.toggle('fa-eye'); });
        dom.successModal.closeBtn.addEventListener('click', () => { hideModal(dom.successModal.el); loadServidores(); showServidoresScreen(); });
        document.querySelectorAll('.opcoes-avaliacao .opcao').forEach(opcao => {
            opcao.addEventListener('click', function() {
                isFormDirty = true;
                const questaoDiv = this.closest('.questao'); const value = this.getAttribute('data-value');
                const hiddenInput = questaoDiv.querySelector('input[type=hidden]'); if (hiddenInput) hiddenInput.value = value;
                this.parentNode.querySelectorAll('.opcao').forEach(op => op.classList.remove('selecionada'));
                this.classList.add('selecionada'); questaoDiv.classList.add('questao-respondida'); questaoDiv.classList.remove('invalid-question');
                calcularPontuacao();
            });
        });
        dom.pagination.nextButton.addEventListener('click', () => {
            if (validateCurrentPage()) { if (currentPageIndex < sections.length - 1) { currentPageIndex++; showPage(currentPageIndex); } }
            else { showToast('Por favor, responda todas as questões para avançar.', 'error', 3000); }
        });
        dom.pagination.prevButton.addEventListener('click', () => { if (currentPageIndex > 0) { currentPageIndex--; showPage(currentPageIndex); } });
        document.getElementById('themeToggle').addEventListener('click', () => { applyTheme(localStorage.getItem('theme') === 'light' ? 'dark' : 'light'); });
        window.addEventListener('beforeunload', (e) => { if (isFormDirty) { e.preventDefault(); e.returnValue = ''; } });
        document.querySelectorAll('.accordion-header').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                button.classList.toggle('active');
                if(content.style.maxHeight) { content.style.maxHeight = null; } 
                else { content.style.maxHeight = content.scrollHeight + "px"; }
            });
        });
        dom.login.matricula.addEventListener('input', filterNumericInput);
        dom.login.senha.addEventListener('input', filterNumericInput);

        const backToTopBtn = document.getElementById('backToTopBtn');
        window.onscroll = () => { backToTopBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "flex" : "none"; };
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { [dom.reviewModal, dom.confirmationModal, dom.successModal.el, dom.infoModal].forEach(m => { if (m.classList.contains('visible')) hideModal(m); }); } });
        
        generateStepper();
        applyTheme(localStorage.getItem('theme') || 'light');
    });
    </script>
</body>
</html>
